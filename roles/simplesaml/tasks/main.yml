---
- name: Install PHP and required modules
  yum:
    name:
      - php
      - php-mbstring
      - php-xml
      - mod_php
    state: latest

- name: Download and Extract SimpleSAMLphp
  unarchive:
    remote_src: https://github.com/simplesamlphp/simplesamlphp/releases/download/v1.19.7/simplesamlphp-1.19.7.tar.gz
    dest: /var/www/

- name: Rename SimpleSAMLphp directory
  command: mv /var/www/simplesamlphp-* /var/www/simplesamlphp

- name: Create config, metadata, and cert directories for SimpleSAMLPHP
  become: yes
  file:
    path: /etc/xdmod/simplesamlphp/{{ item }}
    state: directory
    mode: '0755'
  loop:
    - config
    - metadata
    - cert

- name: Copy all the cert, config and metadata files to appropriate destinations
  become: yes
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: '0644'
  loop:
    - { src: "saml.pem", dest: "/etc/xdmod/simplesamlphp/cert/saml.pem" }
    - { src: "saml.crt", dest: "/etc/xdmod/simplesamlphp/cert/saml.crt" }
    - { src: "config.php", dest: "/etc/xdmod/simplesamlphp/config/config.php" }
    - { src: "authsources.php", dest: "/etc/xdmod/simplesamlphp/config/authsources.php" }
    - { src: "saml20-idp-remote.php", dest: "/etc/xdmod/simplesamlphp/metadata/saml20-idp-remote.php" }

- name: Restart service apache
  service:
    name: http
    state: restarted

